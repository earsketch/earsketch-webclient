<!DOCTYPE html>
<div>Hello, from the LLM extension!</div>
<button>Communicate to LLM</button>
<div id="output" />

<!-- The earsketch dev team will provide this block in the future -->
<script>
    // Setup code we can provide in the form of a module or external script
    let resolver = null

    const earsketch = {
        getEditorContents() {
            window.parent.postMessage(JSON.stringify({
                fn: 'getEditorContents',
            }), '*')
            return new Promise(resolve => { resolver = resolve })
        },
        getScriptExecutionResult() {
            window.parent.postMessage(JSON.stringify({
                fn: 'getScriptExecutionResult',
            }), '*')
            return new Promise(resolve => { resolver = resolve })
        },
        getDawState() {
            window.parent.postMessage(JSON.stringify({
                fn: 'getDawState',
            }), '*')
            return new Promise(resolve => { resolver = resolve })
        },
    }

    window.addEventListener("message", (event) => {
        // console.log("[EXTENSION] Received message from host:", event.data)

        if (event.data === 'init') {
            const sendElement = document.createElement("pre")
            sendElement.textContent = "Connecting to host app\n\n---"
            document.querySelector("#output").appendChild(sendElement)

            earsketch.onload()
        } else if (resolver) {
            console.log("[EXTENSION] Resolving promise...")
            resolver(JSON.parse(event.data))
        }
    })
</script>

<!-- Here's what the extension writer will actually code -->
<script>
    earsketch.onload = async () => {
        document.querySelector("button").addEventListener("click", async () => {
            // Configure the button to simulate a chat message to a remote LLM
            console.log("[EXTENSION] Button clicked, fetching editor contents...")
            const contents = await earsketch.getEditorContents()

            console.log("[EXTENSION] ...fetching script run result...")
            const scriptResult = await earsketch.getScriptExecutionResult()
            const dawState = await earsketch.getDawState()

            let sendElement = document.createElement("pre")
            const contentsPretty = contents.slice(0, 20)
            sendElement.textContent = "Sending to code to LLM (mock):\n" + contentsPretty + "...\n\n---"
            document.querySelector("#output").appendChild(sendElement)

            sendElement = document.createElement("pre")
            const scriptResultPretty = JSON.stringify(JSON.parse(scriptResult), null, 2)
            sendElement.textContent = "Sending run result to LLM (mock):\n" + scriptResultPretty + "\n\n---"
            document.querySelector("#output").appendChild(sendElement)

            sendElement = document.createElement("pre")
            const dawStatePretty = JSON.stringify(JSON.parse(dawState), null, 2)
            sendElement.textContent = "Sending daw state to LLM (mock):\n" + dawStatePretty + "\n\n---"
            document.querySelector("#output").appendChild(sendElement)

            setTimeout(() => {
                const respElement = document.createElement("pre")
                respElement.textContent = "Response from LLM (mock):\nThank you!\n\n---"
                document.querySelector("#output").appendChild(respElement)
            }, 1000)
        })
    }
</script>
